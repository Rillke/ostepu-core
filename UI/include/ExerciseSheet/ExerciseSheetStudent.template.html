<?php
if (!empty($sheets)) {
foreach ($sheets as $sheet):

    /**
     * @todo Date check needs more testing.
     */

    // bool if endDate of sheet is greater than the actual date
    $isExpired = date('U') > date('U', $sheet['endDate']);
?>
<div class="content-element collapsible">
    <div class="content-header">
        <div class="content-title left uppercase">
            <?php
                print $sheet['sheetName'];
                if ($isExpired) {
                    print ' (abgelaufen)';
                }
            ?>
        </div>
        <div class="critical-color bold right">
            <?php print date('d.m.Y  -  H:i', $sheet['endDate']); ?>
        </div>
        <div class="exercise-sheet-info info-color bold right">
            <?php print $sheet['percentage'] . '%'; ?>
        </div>
    </div>

    <div class="content-body-wrapper">
        <div class="content-body left">
            <ol class="exercise-list">
                <?php
                foreach ($sheet['exercises'] as $exercise):
                ?>
                <li>

                    <div class="exercise-type">
                        <?php print $exercise['typeName']; ?>
                    </div>

                    <div class="exercise-points">
                        <?php
                            // prints the achieved and the maximum points
                            if(isset($exercise['submission']['marking'])) {
                                print $exercise['submission']['marking']['points'];
                            }
                            else {
                                print "-";
                            }
                            print ' / ' . $exercise['maxPoints'] . ' P';
                        ?>
                    </div>

                    <div class="exercise-sheet-images">
                        <?php
                            // creates an upload icon
                            print '<a href="';
                            print 'Upload.php?cid=' . $cid . '&sid=' . $sheet['id'];
                            print '" title="Upload" ';
                            print 'class="plain inline">';
                            print '<img src="Images/Upload.png" />';
                            print '</a>';
                        ?>

                        <?php
                            // creates a download icon for the submission (if it exists)
                            if(isset($exercise['submission'])) {
                                $displayName = $exercise['submission']['file']['displayName'];
                                $fileAddress = $exercise['submission']['file']['address'];
                                $fileURL = $filesystemURI . '/' . $fileAddress . '/' . $displayName;

                                print '<a href="';
                                print $fileURL;
                                print '" title="';
                                print $displayName;
                                print '" class="plain" target="_blank">';
                                print '<img src="Images/Download.png" />';
                                print '</a>';
                            }
                        ?>

                        <?php
                            // creates a downloadCorrection icon for the marking (if it exists)
                            if(isset($exercise['submission']['marking'])) {
                                $displayName = $exercise['submission']['marking']['file']['displayName'];
                                $fileAddress = $exercise['submission']['marking']['file']['address'];
                                $fileURL = $filesystemURI . '/' . $fileAddress . '/' . $displayName;

                                print '<a href="';
                                print $fileURL;
                                print '" title="';
                                print $displayName;
                                print '" class="plain" target="_blank">';
                                print '<img src="Images/DownloadCorrection.png" />';
                                print '</a>';
                            }
                        ?>

                        <?php
                            // creates a downloadAttachment icon for the exercise (if it exists)
                            if(isset($exercise['attachment'])) {
                                $displayName = $exercise['attachment']['displayName'];
                                $fileAddress = $exercise['attachment']['address'];
                                $fileURL = $filesystemURI . '/' . $fileAddress . '/' . $displayName;

                                print '<a href="';
                                print $fileURL;
                                print '" title="';
                                print $displayName;
                                print '" class="plain" target="_blank">';
                                print '<img src="Images/Attachment.png" />';
                                print '</a>';
                            }
                        ?>

                        <?php
                            // creates a deleteSubmission icon for the submission (if it exists)

                            /**
                             * @todo add "&& !$isExpired" to if condition after testing.
                             */ 
                            if(isset($exercise['submission'])) {
                                print '<a href="Student.php?cid=';
                                print $cid . '&action=deleteSubmission';
                                print '&suid=' . $exercise['submission']['id'];
                                print '" title="Einsendung löschen" class="plain" target="_blank">';
                                print '<img src="Images/Delete.png" />';
                                print '</a>';
                            }
                        ?>
                    </div>
                </li>
                <?php
                endforeach;
                ?>
            </ol>
        </div>

        <div class="content-body right">
            <ol class="body-options body-option-color">
                <li>
                    <?php
                        $displayName = $sheet['sheetFile']['displayName'];
                        $fileAddress = $sheet['sheetFile']['address'];
                        $fileURL = $filesystemURI . '/' . $fileAddress . '/' . $displayName;
                    ?>
                    <a href="<?= $fileURL ?>" title="<?= $displayName ?>" target="_blank">
                        Aufgabenblatt
                    </a>
                </li>
                    <?php
                        // shows link to sampleSolution
                        if ($isExpired) {
                            $displayName = $sheet['sampleSolution']['displayName'];
                            $fileAddress = $sheet['sampleSolution']['address'];
                            $fileURL = $filesystemURI . '/' . $fileAddress . '/' . $displayName;

                            print '<li>';
                            print '<a href="';
                            print $fileURL . '" title="';
                            print $displayName . '" target="_blank">';
                            print 'Musterlösung';
                            print '</a>';
                            print '</li>';
                        }
                    ?>
                <li>
                    <a href="Group.php?sid=<?= $sheet['id'], '&cid=', $cid ?>">
                        Gruppe verwalten
                    </a>
                </li>
                <?php
                    if ($sheet['hasAttachments']) {
                        print '<li>';
                        print '<a href="Tutor.php?cid=';
                        print $cid . '&action=downloadAttachments';
                        print '&sid=' . $sheet['id'];
                        print '">Alle Anhänge herunterladen</a>';
                        print '</li>';
                    }
                ?>
                <?php
                    if ($sheet['hasMarkings']) {
                        print '<li>';
                        print '<a href="Student.php?cid=';
                        print $cid . '&action=downloadMarkings';
                        print '&sid=' . $sheet['id'];
                        print '">Alle Einsendungen herunterladen</a>';
                        print '</li>';
                    }
                ?>
            </ol>
        </div>
    </div> <!-- end: content-body-wrapper -->

    <?php
        // prints a footer list-item for every group member of the sheet
        if (isset($sheet['group']['members'][0])) {
            print '<div class="content-footer">';
            print '<ol>';
            print '<li class="footer-text bold">In Gruppe mit:</li>';
            foreach ($sheet['group']['members'] as $member):
                print '<li class="footer-text">';
                print $member['firstName'] . " " . $member['lastName'];
                print '</li>';
            endforeach;
            print '</ol>';
            print '</div>';
        }
    ?>
</div> <!-- end: content-element -->
<?php 
endforeach;
} else {
?>
<div class="content-element">
    <div class="content-header">
        <div class="content-title left uppercase">Hinweis</div>
    </div>

    <div class="content-body-wrapper">
        <div class="content-body left">
            Es sind noch keine Aufgabenblätter vorhanden.
        </div>
    </div> <!-- end: content-body -->
</div> <!-- end: content-wrapper -->
<?php
}
?>