<?php 
    $anyoneStarted=false;
    if (!empty($sheets))
        foreach ($sheets as $sheet)
            if (date('U') > date('U', $sheet['startDate'])){
                $anyoneStarted=true;
                break;
            }
    
    if (!empty($sheets) && $anyoneStarted): ?>
    <?php foreach ($sheets as $sheet):?>
    <?php /**
           * @todo Date check needs more testing.
           */

           // bool if endDate of sheet is greater than the actual date
           $isExpired = date('U') > date('U', $sheet['endDate']);

           // bool if startDate of sheet is greater than the actual date
           $hasStarted = date('U') > date('U', $sheet['startDate']);
           if (!$hasStarted) continue;
           ?>
    <div class="content-element collapsible">
        <div class="content-header">
            <div class="content-title left uppercase">
                <?php echo $sheet['sheetName'], " "; ?>
                <?php if ($isExpired): ?>
                    (abgelaufen)
                <?php endif; ?>
            </div>
               
            <div class="critical-color bold right">
                <?php echo date('d.m.Y  -  H:i', $sheet['endDate']); ?>
            </div>
            <div class="info-color bold right">
            <?php if (!$isExpired){ ?>
                <?php echo date('d.m.Y  -  H:i', $sheet['startDate']).' bis&nbsp;'; ?>
                <?php } ?>
            </div>
            
            <div class="exercise-sheet-info info-color bold right">
                <?php if ($isExpired) echo $sheet['percentage'], '%';?>
            </div>
        </div>

        <div class="content-body-wrapper">
            <div class="content-body left">
                <ol class="exercise-list">
                    <?php 
                    // bool if subtasks are printed
                    $isSubtask = false;
                    foreach ($sheet['exercises'] as $key => $exercise): 
                    ?>
                    <?php
                    // make a sublist if next exercise is not a main exercise
                    if (isset($sheet['exercises'][$key+1]) && $sheet['exercises'][$key+1]['linkName'] != 1 && $isSubtask == false) {
                        $isSubtask = true;
                        print "<li class=\"subexercise-list\"><ol>";
                    }
                    ?>
                    <li>
                        <div class="exercise-type">
                            <?php echo $exercise['typeName']; ?>
                            <?php echo $exercise['bonus'] ? ' (B)' : ''; ?>
                        </div>

                        <div class="exercise-points">
                            <?php // prints the achieved and the maximum points ?>
                            <?php if (isset($exercise['submission']['marking'])
                                     && $isExpired
                                     && $exercise['submission']['marking']['statusId'] >= 2): ?>
                                <?php echo $exercise['submission']['marking']['points']; ?>
                            <?php else: ?>
                                -
                            <?php endif; ?>
                            / <?php echo $exercise['maxPoints']; ?> P
                        </div>

                        <div class="exercise-status">
                            <?php if (isset($exercise['submission']['marking']) && $isExpired): ?>
                                <?php echo $exercise['submission']['marking']['status']; ?>
                            <?php elseif (isset($exercise['submission']) || (isset($exercise['submission']['marking']) && !$isExpired)): ?>
                                unkorrigiert
                            <?php else: ?>
                                nicht eingesendet
                            <?php endif; ?>
                        </div>

                        <div class="exercise-sheet-images">
                            <?php // creates a downloadAttachment icon for the exercise (if it exists) ?>
                            <?php if(isset($exercise['attachment'])): ?>
                                <?php $displayName = $exercise['attachment']['displayName']; ?>
                                <?php $fileAddress = $exercise['attachment']['address']; ?>
                                <?php $fileURL = "../FS/FSBinder/{$fileAddress}/{$displayName}";/*{$filesystemURI}*/ ?>

                                <a href="<?php echo $fileURL; ?>" title="<?php echo $displayName; ?>" class="plain" target="_blank">
                                    <img src="Images/Attachment.png" />
                                </a>
                            <?php endif; ?>

                            <?php // creates a download icon for the submission (if it exists) ?>
                            <?php if(isset($exercise['submission']) && $exercise['submission']['hideFile'] == "0"): ?>
                                <?php $displayName = $exercise['submission']['file']['displayName']; ?>
                                <?php $fileAddress = $exercise['submission']['file']['address']; ?>
                                <?php $fileURL = "../FS/FSBinder/{$fileAddress}/{$displayName}";/*{$filesystemURI}*/ ?>

                                <a href="<?php echo $fileURL; ?>" title="<?php echo $displayName; ?>" class="plain" target="_blank">
                                    <img src="Images/Download.png" />
                                </a>
                            <?php endif; ?>

                            <?php // creates a downloadCorrection icon for the marking (if it exists) ?>
                            <?php if(isset($exercise['submission']['marking']['file']) && $exercise['submission']['marking']['hideFile'] == "0" && $isExpired): ?>
                                <?php $displayName = $exercise['submission']['marking']['file']['displayName']; ?>
                                <?php $fileAddress = $exercise['submission']['marking']['file']['address']; ?>
                                <?php $fileURL = "../FS/FSBinder/{$fileAddress}/{$displayName}";/*{$filesystemURI}*/ ?>

                                <a href="<?php echo $fileURL; ?>" title="<?php echo $displayName; ?>" class="plain image-button" target="_blank">
                                    <img src="Images/DownloadCorrection.png" />
                                </a>
                            <?php endif; ?>

                            <?php // creates a deleteSubmission icon for the submission (if it exists) ?>
                            <?php if (isset($exercise['submission']) 
                                      && !$isExpired
                                      && $exercise['submission']['hideFile'] == "0"): ?>    
                                    <button title="Einsendung löschen" name="<?php echo (!isset($_POST['deleteSubmissionWarning']) || (isset($_POST['deleteSubmission']) && $_POST['deleteSubmission'] != $exercise['submission']['id'])) ? 'deleteSubmissionWarning' : 'deleteSubmission';?>" value="<?php echo $exercise['submission']['id']; ?>"class="image-button<?php echo (!isset($_POST['deleteSubmissionWarning']) || (isset($_POST['deleteSubmissionWarning']) && $_POST['deleteSubmissionWarning'] != $exercise['submission']['id'])) ? ' ' : '-simple  error-simple' ;?>">                                      
                                        <img src="Images/Delete.png">
                                    </button>
                            <?php endif; ?>
                            
                        </div>
                             
                    </li>
                            
                            <?php if (isset($exercise['submission']['marking']['tutorComment']) && trim($exercise['submission']['marking']['tutorComment']) != '') { 
                            $comment = trim($exercise['submission']['marking']['tutorComment']); ?>
                            <div class="" style="margin-top:-10px;margin-bottom:0px;word-break: break-all;">
                            <table border="0" style="width:auto">
                            <tr><td class="medium">
                            <span class="footer-text bold">Bemerkung: </span>
                            </td><td class="wider">
                            <span class="footer-text info-color"><?php echo $comment; ?></span>
                            </td><tr></table></div>
                            <?php } ?>
 
                    <?php
                    // close subexerciselist if next exercise is a new mainexercise or end of exercises is reached
                    if (isset($sheet['exercises'][$key+1]) && $sheet['exercises'][$key+1]['linkName'] == 1 && $isSubtask == true) {
                        $isSubtask = false;
                        print "</ol></li>";
                    } elseif (isset($sheet['exercises'][$key+1]) == false && $isSubtask == true) {
                        $isSubtask = false;
                        print "</ol></li>";
                    }
                    ?>
                    <?php endforeach; ?>
                </ol>
            </div>

            <div class="content-body right">
                <ol class="body-options body-option-color">
                    <?php // creates a downloadAttachment icon for the exercise (if it exists) ?>
                    <?php if($isExpired && isset($sheet['sampleSolution'])): ?>
                        <?php $displayName = $sheet['sampleSolution']['displayName']; ?>
                        <?php $fileAddress = $sheet['sampleSolution']['address']; ?>
                        <?php $fileURL = "../FS/FSBinder/{$fileAddress}/{$displayName}"; /*{$filesystemURI}*/?>
                        <li>
                            <a href="<?php echo $fileURL; ?>" title="<?php echo $displayName; ?>" target="_blank">
                                Musterlösung
                            </a>
                        </li>
                    <?php endif; ?>

                    <li>
                        <?php if (isset($sheet['sheetFile']['address'])){?>
                        <?php $displayName = $sheet['sheetFile']['displayName']; ?>
                        <?php $fileAddress = $sheet['sheetFile']['address']; ?>
                        <?php $fileURL = "../FS/FSBinder/{$fileAddress}/{$displayName}"; /*{$filesystemURI}*/?>
                        <a href="<?php echo $fileURL; ?>" title="<?php echo $displayName; ?>" target="_blank">
                            Aufgabenblatt
                        </a>
                        <?php } ?>
                    </li>
                    
                    <li>
                        <?php 
                        if ($isExpired){
                        ?>
                            <a style="color:#b9b8b8"><s>
                        <?php } else { ?>
                            <a style="color:#b9b8b8"><s><!--<a href="Group.php?sid=<?php echo $sheet['id'], '&cid=', $cid; ?>">-->
                        <?php } ?>
                        Gruppe verwalten
                        </s>></a>
                    </li>

                    <li>
                        <?php 
                        if ($isExpired){
                        ?>
                            <a style="color:#b9b8b8">
                        <?php } else { ?>
                            <a href="Upload.php?cid=<?php echo $cid; ?>&sid=<?php echo $sheet['id']; ?>" title="Upload">
                        <?php } ?>
                            Aufgaben hochladen
                            </a>
                    </li>

                    <?php // prints a link to download attachments ?>
                    <?php if ($sheet['hasAttachments']): ?>
                        <li>
                            <a href="Download.php?cid=<?php echo $cid; ?>&downloadAttachments=<?php echo $sheet['id']; ?>" class="download text-button body-option-color">
                                Alle Anhänge herunterladen
                            </a>
                        </li>
                    <?php endif; ?>

                    <?php // prints a link to download markings ?>
                    <?php if (($sheet['hasMarkings'] || $sheet['hasSubmissions'] || $sheet['hasAttachments']) && $isExpired): ?>
                        <li>
                            <a href="Download.php?cid=<?php echo $cid; ?>&downloadMarkings=<?php echo $sheet['id']; ?>" class="download text-button body-option-color">
                                Alles herunterladen
                            </a>
                        </li>
                    <?php endif; ?>
                </ol>
            </div>
        </div> <!-- end: content-body-wrapper -->

        <?php // prints a footer list-item for every group member of the sheet ?>
        <?php if (isset($sheet['group']['members'][0])): ?>
            <div class="content-footer">
                <ol>
                    <li class="footer-text bold">
                        In Gruppe mit:
                    </li>
                    <?php foreach ($sheet['group']['members'] as $member): ?>
                        <li class="footer-text">
                            <?php echo $member['firstName'], " ", $member['lastName']; ?>
                        </li>
                    <?php endforeach; ?>
                </ol>
            </div>
        <?php endif; ?>
    </div> <!-- end: content-element -->
    <?php endforeach; ?>
<?php else: ?>
    <div class="content-element">
        <div class="content-header">
            <div class="content-title left uppercase">Hinweis</div>
        </div>

        <div class="content-body-wrapper">
            <div class="content-body left">
                Es sind noch keine Aufgabenblätter vorhanden.
            </div>
        </div> <!-- end: content-body -->
    </div> <!-- end: content-wrapper -->
<?php endif; ?>
