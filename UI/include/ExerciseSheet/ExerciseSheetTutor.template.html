<?php if (!empty($sheets)): ?>
    <?php foreach ($sheets as $sheet):?>
    <?php /**
           * @todo Date check needs more testing.
           */

           // bool if endDate of sheet is greater than the actual date ?>
    <?php $isExpired = date('U') > date('U', $sheet['endDate']); ?>
    <div class="content-element collapsible">
        <div class="content-header">
            <div class="content-title left uppercase">
                    <?php echo $sheet['sheetName'], " "; ?>
                    <?php if ($isExpired): ?>
                        (abgelaufen)
                    <?php endif; ?>
            </div>
            <div class="info-color bold footer-text">
                    <?php if (isset($sheet['status'])){
                                $types = Marking::getStatusDefinition();
                                foreach ($sheet['status'] as $key => $value){ ?>
                                <?php echo $value.' '.$types[LArraySorter::multidimensional_search($types, array('id'=>$key))]['longName'];?>
                    <?php }} ?>
            </div>
            <div class="critical-color bold right">
                <?php echo date('d.m.Y  -  H:i', $sheet['endDate']); ?>
            </div>
            <div class="info-color bold right">
                <?php echo date('d.m.Y  -  H:i', $sheet['startDate']).' bis&nbsp;'; ?>
            </div>
            
            <div class="exercise-sheet-info info-color bold right">
                <?php 
                    /**
                     * @todo Number of submissions without markings still needs to be 
                     *       calculated in GetSite.
                     */
                ?>
                <?php if (isset($sheet['exerciseSheetInfo'])) echo $sheet['exerciseSheetInfo'], ' unkorrigiert'; ?>
            </div>
        </div>

        <div class="content-body-wrapper">
            <div class="content-body left">
                <ol class="exercise-list">
                    <?php 
                    // bool if subtasks are printed
                    $isSubtask = false;
                    foreach ($sheet['exercises'] as $key => $exercise): 
                    ?>
                    <?php
                    // make a sublist if next exercise is not a main exercise
                    if (isset($sheet['exercises'][$key+1]) && $sheet['exercises'][$key+1]['linkName'] != 1 && $isSubtask == false) {
                        $isSubtask = true;
                        print "<li class=\"subexercise-list\"><ol>";
                    }
                    ?>
                    <li>
                        <div class="exercise-type">
                            <?php echo $exercise['typeName']; ?>
                            <?php echo $exercise['bonus'] ? ' (*)' : ''; ?>
                        </div>
                        <div class="exercise-points">
                            <?php echo $exercise['maxPoints'];?> P
                        </div>
                        <div class="exercise-sheet-images">
                        <?php // creates a downloadAttachment icon for the exercise (if it exists) ?>
                        <?php if(isset($exercise['attachment'])): ?>
                            <?php $displayName = $exercise['attachment']['displayName']; ?>
                            <?php $fileAddress = $exercise['attachment']['address']; ?>
                            <?php $fileURL = "../FS/FSBinder/{$fileAddress}/{$displayName}"; /*{$filesystemURI}*/?>

                            <a href="<?php echo $fileURL; ?>" title="<?php echo $displayName; ?>" class="plain" target="_blank">
                                <img src="Images/Attachment.png" />
                            </a>
                        <?php endif; ?>
                        </div>
                    </li>
                    <?php
                    // close subexerciselist if next exercise is a new mainexercise or end of exercises is reached
                    if (isset($sheet['exercises'][$key+1]) && $sheet['exercises'][$key+1]['linkName'] == 1 && $isSubtask == true) {
                        $isSubtask = false;
                        print "</ol></li>";
                    } elseif (isset($sheet['exercises'][$key+1]) == false && $isSubtask == true) {
                        $isSubtask = false;
                        print "</ol></li>";
                    }
                    ?>
                    <?php endforeach; ?>
                </ol>
                    <li class="footer-text bold">Einsendungen:</li>
                    <li class="footer-text"><?php echo $sheet['courseUserCount']; ?> Studenten</li>
                    <li class="footer-text"><?php echo $sheet['selectedSubmissions']; ?> Einsendungen</li>
                    <li class="footer-text"><?php echo $sheet['tutorMarkings']; ?> Korrekturaufträge</li>
                    <?php if (isset($sheet['status'])){ ?>
                    <br>
                    <li class="footer-text bold">meine Korrekturen:</li>
                    <?php $types = Marking::getStatusDefinition();
                    foreach ($sheet['status'] as $key => $value){ ?>
                    <li class="footer-text">
                    <button name="downloadCSV_<?php echo $key;?>" value="<?php echo $sheet['id']; ?>" class="text-button body-option-color footer-text" style="padding-left:0px">
                    <?php echo $value.' '.$types[LArraySorter::multidimensional_search($types, array('id'=>$key))]['longName'];?> 
                    </button></li>
                    <?php }} ?>
                    <?php if (isset($sheet['allStatus'])){ ?>
                    <br>
                    <li class="footer-text bold">alle Korrekturen:</li>
                    <?php $types = Marking::getStatusDefinition();
                    foreach ($sheet['allStatus'] as $key => $value){ ?>
                    <li class="footer-text">
                    <?php echo $value.' '.$types[LArraySorter::multidimensional_search($types, array('id'=>$key))]['longName'];?>
                    </li>
                    <?php }} ?>
                    
            </div>
            <div class="content-body right">
                <ol class="body-options body-option-color">
                    <?php if (isset($sheet['sampleSolution'])): ?>
                        <li>
                            <?php $displayName = $sheet['sampleSolution']['displayName']; ?>
                            <?php $fileAddress = $sheet['sampleSolution']['address']; ?>
                            <?php $fileURL = "../FS/FSBinder/{$fileAddress}/{$displayName}"; /*{$filesystemURI}*/?>
                            <a href="<?php echo $fileURL; ?>" title="<?php echo $displayName; ?>" target="_blank">
                                Musterlösung
                            </a>
                        </li>
                    <?php endif; ?>
                    
                    <?php if (isset($sheet['sheetFile']['address'])){?>
                    <li>
                        <?php $displayName = $sheet['sheetFile']['displayName']; ?>
                        <?php $fileAddress = $sheet['sheetFile']['address']; ?>
                        <?php $fileURL = "../FS/FSBinder/{$fileAddress}/{$displayName}"; /*{$filesystemURI}*/?>
                        <a href="<?php echo $fileURL; ?>" title="<?php echo $displayName; ?>" target="_blank">
                            Aufgabenblatt
                        </a>
                    </li>
                    <?php } ?>

                    <?php // prints a link to download attachments ?>
                    <?php if ($sheet['hasAttachments']): ?>
                        <li>
                            <button name="downloadAttachments" value="<?php echo $sheet['id']; ?>" class="text-button body-option-color">
                                Alle Anhänge herunterladen
                            </button>
                        </li>
                    <?php endif; ?>
                    
                    <?php if (isset($sheet['tutorMarkings']) && $sheet['tutorMarkings']>0){ ?>
                    <li>
                        <button name="downloadCSV" value="<?php echo $sheet['id']; ?>" class="text-button body-option-color">
                            Einsendungen herunterladen
                        </button>
                    </li>

                    <li>
                        <a href="TutorUpload.php?cid=<?php echo $user['courses'][0]['course']['id'],
                                                         '&sid=',
                                                         $sheet['id']; ?>">
                            Korrekturen hochladen
                        </a>
                    </li>
                    <?php } ?>
                    
                    <li>
                        <a href="TutorAssign.php?cid=<?php echo $user['courses'][0]['course']['id'],
                                                         '&sid=',
                                                         $sheet['id']; ?>">
                            Kontrolleurzuweisung
                        </a>
                    </li>
                    <li>
                        <a href="MarkingTool.php?cid=<?php echo $user['courses'][0]['course']['id'],
                                                         '&sid=',
                                                         $sheet['id']; ?>">
                            Korrekturassistent
                        </a>
                    </li>
                </ol>
            </div>
        </div>

    </div> <!-- end: content-element -->
    <?php endforeach; ?>
<?php else: ?>
    <div class="content-element">
        <div class="content-header">
            <div class="content-title left uppercase">Hinweis</div>
        </div>

        <div class="content-body-wrapper">
            <div class="content-body left">
                Es sind noch keine Aufgabenblätter vorhanden.
            </div>
        </div> <!-- end: content-body -->
    </div> <!-- end: content-wrapper -->
<?php endif; ?>