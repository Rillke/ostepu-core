<?php
if (isset($UploadHistoryNotificationElements)) {
    foreach ($UploadHistoryNotificationElements as $notificationElement) {
        print $notificationElement;
    }
}
?>

<?php 
    if (!isset($exercises)) return;
    if (isset($_POST['sortUsers']))
        echo "<input type='hidden' name='sortUsers' value='{$_POST['sortUsers']}'>";
    if (isset($_POST['sheetID']))
        echo "<input type='hidden' name='sheetID' value='{$_POST['sheetID']}'>";
    if (isset($_POST['userID']))
        echo "<input type='hidden' name='userID' value='{$_POST['userID']}'>";
    if (isset($_POST['action']) && $_POST['action']=="ShowUploadHistory")
        echo "<input type='hidden' name='action' value='{$_POST['action']}'>";
        
    // bool if subtasks are printed
    $count=null;
    $namesOfExercises=array();
    $alphabet = range('a', 'z');
    foreach ($exercises as $key => $exercise){
        $exerciseId = $exercise['id'];

        if ($count===null || $exercises[$count]['link'] != $exercise['link']){
            $count=$key;
            $namesOfExercises[$exerciseId] = 'AUFGABE '.$exercise['link'];
            $subtask = 0;
        }else{
            $subtask++;
            $namesOfExercises[$exerciseId] = 'AUFGABE '.$exercise['link'].$alphabet[$subtask];
            $namesOfExercises[$exercises[$count]['id']] = 'AUFGABE '.$exercises[$count]['link'].$alphabet[0];
        }
    }
    
    $isSubtask = false;
    if (isset($submissionHistory))
    foreach ($exercises as $ex):
    $key = $ex['id'];
?>
<div class="content-element">
    <div class="content-header">
        <div class="content-title left"><?php echo $namesOfExercises[$key];?></div>
    </div>

    <div class="content-body-wrapper">
        <div class="content-body left">
            <?php
                $noSubmission = true;
                if (!empty($submissionHistory[$key])) {
                    foreach ($submissionHistory[$key] as $submission) {
                        if ($submission['hideFile'] == "0") {
                            $noSubmission = false;

                            // prints the submission date
                            $selected = (isset($submission['selectedForGroup']) && $submission['selectedForGroup']==1) ? true : false;
                            echo '<div class="form-field left bold new-line '. ($selected ? 'critical-color' : '') .'">';
                            print date('d.m.Y  -  H:i', $submission['date']);
                            if (!$selected){ 
                            $obj=array("id"=>$submission['id'], "leaderId"=>$submission['leaderId'], "exerciseId"=>$submission['exerciseId']);
                            ?>
                            <button name="updateSelectedSubmission" value="<?php echo htmlentities(json_encode($obj)); ?>" class="medium text-button-simple body-option-color footer-text">
                            >>
                            </button>
                            <?php }
                            print '</div>';                            

                            $displayName = $submission['file']['displayName'];
                            $fileAddress = $submission['file']['address'];
                            $fileSize = $submission['file']['fileSize'];

                            // prints the link for downloading the submission
                            print '<a class="left '.($selected ? 'bold critical-color' : 'body-option-color').'" href="';
                            print  '../FS/FSBinder/' . $fileAddress . '/' . $displayName; //$filesystemURI
                            print '" title="';
                            print $displayName;
                            print '" target="_blank">Einsendung ansehen';
                            print ' (' . formatBytes($fileSize) . ') ';
                            print '</a>';
                        }
                    }
                }

                if ($noSubmission) {
                    print 'Keine Einsendungen vorhanden.';
                }
            ?>
        </div>
    </div>
</div>
<?php
    // set isSubtask to false if next exercise is a new mainexercise or end of exercises is reached
    if ((isset($exercises[$key+1]) && $exercises[$key+1]['linkName'] == 1 && $isSubtask == true) ||
        (isset($exercises[$key+1]) == false && $isSubtask == true)) {
        $isSubtask = false;
    }
    endforeach;
?>